
# خطة تطوير نظام "وضع الخطة" ومنع الفتح التلقائي للمعاينة

## المشكلة الحالية
1. المستخدم يرسل رسالة واحدة والذكاء الاصطناعي يبني الموقع مباشرة بدون أسئلة كافية
2. المعاينة تنفتح تلقائياً بمجرد توليد الملفات (عبر `setMobileView("preview")`)

## الحل المقترح

### 1. تحسين نظام الأسئلة في الـ Edge Function (barq-chat)

تعديل `SYSTEM_PROMPT` في `supabase/functions/barq-chat/index.ts` لتكون التعليمات أكثر صرامة:
- الذكاء الاصطناعي يسأل **سؤال واحد فقط في كل رد** (مو عدة أسئلة مرة وحدة)
- الترتيب: اسم المشروع -> نوع النشاط -> التفاصيل (خدمات/ألوان/محتوى) -> تأكيد
- بعد جمع المعلومات الكافية (3-4 جولات)، يرسل رسالة تأكيد مع عبارة واضحة مثل: "جاهز أبدأ البناء؟"
- **لا يستدعي أداة `generate_website` إلا إذا المستخدم قال "ابدأ" أو "يلا" أو ما يشابهها**

### 2. إزالة الفتح التلقائي للمعاينة

في `src/pages/BuilderPage.tsx`:
- إزالة `setMobileView("preview")` من callback الـ `onDone`
- بدلاً من ذلك، إضافة رسالة تنبيه (toast) تقول "المعاينة جاهزة!" مع زر "انتقل للمعاينة"
- الزر يوجه المستخدم للمعاينة عند الضغط عليه

### 3. إضافة زر "المعاينة جاهزة" في المحادثة

بعد اكتمال بناء الملفات، تظهر رسالة خاصة في المحادثة فيها زر واضح "اضغط هنا لمعاينة موقعك" بدل ما تنفتح المعاينة تلقائياً.

---

## التفاصيل التقنية

### ملف `supabase/functions/barq-chat/index.ts`
- تعديل SYSTEM_PROMPT لإضافة قواعد صارمة:
  - "اسأل سؤال واحد فقط في كل رد"
  - "لا تستخدم أداة generate_website إلا بعد 3 جولات أسئلة على الأقل وبعد موافقة المستخدم"
  - "بعد جمع المعلومات أرسل ملخص واسأل: جاهز نبدأ البناء؟"

### ملف `src/pages/BuilderPage.tsx`
- في `onDone` callback (سطر 248-254):
  - إزالة `setMobileView("preview")`
  - إضافة toast تفاعلي مع زر للمعاينة
- إضافة state جديد `previewReady` لتتبع جاهزية المعاينة
- عرض زر "معاينة الموقع" في رسالة المساعد الأخيرة عند اكتمال البناء

### ملف `src/hooks/useVFS.ts`
- لا يحتاج تغيير

### التغييرات المطلوبة:
1. `supabase/functions/barq-chat/index.ts` - تحديث SYSTEM_PROMPT
2. `src/pages/BuilderPage.tsx` - تعديل سلوك onDone وإضافة زر المعاينة التفاعلي
